<%= javascript_include_tag params[:static_pages] %>
<%= stylesheet_link_tag params[:static_pages] %>

<div class="frame">
		<span class="helper"></span><div class="logo"><img src="/assets/corpsquare.png" /></div>

		<div id="input-location-div">
			<input type="text" id="input-location" placeholder="Where are you going?">
      <button id="submit-location-button" type="button">Search</button>
			<div class="tagline">Traveling? Find out where your coworkers have been to help you figure out where to go.</div>
		</div>
</div>

<script>
  var entriesJson = <%= @expenseEntries.to_s.html_safe %>;
  var venues = [];
  var inputLocation;
  entriesJson['entries'].forEach(function(entry, index, array){
      var venue = {}
      var results = entry['VendorDescription'].split(',');
      venue['name'] = results[0];
      venue['city'] = results[1];
      venue['amount'] = entry['ApprovedAmount'];
      venues.push(venue);
  });

// global variables
  var placesvisited;
  var centerLatlng;
  var mapOptions;
  var map;
  var venuesByLocation = [];
  var expenses = new Array();
  var query = "&query=cronut";
  var baseurl = "https://api.foursquare.com/v2/venues/search?near=New York, NY&oauth_token=EKPQAGKVMLBNB2VCDWREWFSJJHNCRGRQEEEKJTJ10JS5E0WY&v=20140503"

  function populateVenues() {
    venues.forEach(function(venue,index)
        {
          query = "&query="+venue.vendorName;
          $.get( baseurl + query, function( data ) {
            venue['latitude'] = data.response.venues[1].location.lat;
            venue['longitude'] = data.response.venues[1].location.lng;
            $( ".inner" ).append( "<p>Name:"+venue.name +"  lat:"+ venue.latitude +"  lng:"+ venue.longitude + "<\p> END");
          });
        });
  }

  var getVenuesByLocation = function(inputLocation) {
    console.log('inside getVenuesByLocation');
    console.log('venues:');
    console.log(venues);
    venues.forEach(function(venue, index){
      console.log('inside venues forEach');
        if(venue.city.toLowerCase() === inputLocation.toLowerCase()) {
          console.log('venue:');
          console.log(venue);
          venuesByLocation.push(venue);
          console.log('venuesByLocation');
          console.log(venuesByLocation);
        }
    });
  }

  var initializeMap = function(){
    placesvisited = ["-10.238278,40.044677", "-10.238278,110.044800"];
    centerLatlng = new google.maps.LatLng("-10.238278","40.044677");
    mapOptions = {
      zoom: 4,
      center: centerLatlng
    };
    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  }

  function drawMarker(lat, lng) {
    var myLatlng = new google.maps.LatLng(lat,lng);

    var contentString = '<div id="content">'+
        '<div id="siteNotice">'+
        '</div>'+
        '<h1 id="firstHeading" class="firstHeading">Amine</h1>'+
        '<div id="bodyContent">'+
        '<p><b>Amine</b>, spent $500 here '+
        '(last visited June 22, 2009).</p>'+
        '</div>'+
        '</div>';

    var infowindow = new google.maps.InfoWindow({
        content: contentString
    });

    var marker = new google.maps.Marker({
        position: myLatlng,
        map: map,
        title: 'Uluru (Ayers Rock)'
    });
    google.maps.event.addListener(marker, 'click', function() {
      infowindow.open(map,marker);
    });
  }

  function drawMap(){
    console.log('inside drawMap');
    console.log('venuesByLocation');
    console.log(venuesByLocation);
    venuesByLocation.forEach(function(venue, index){
      console.log('latitude: ');
      console.log(venue.latitude);
      console.log('longitude: ');
      console.log(venue.longitude);
      drawMarker(venue.latitude, venue.longitude);
    });
  }

  var submitLocation = function(event) {
    event.preventDefault();
    inputLocation = $('#input-location').val();
    getVenuesByLocation(inputLocation);
    initializeMap();
    drawMap();
    // google.maps.event.addDomListener(window, 'load', drawMap);
  }

  $( document ).ready(function() {
      populateVenues();
      $('#submit-location-button').click(submitLocation);
  });
</script>

<h1>Dump Here:</h1>
<div class="inner">
</div>
<div id="map-canvas"></div>
